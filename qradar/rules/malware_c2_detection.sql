-- Malware C2 Communication Detection
-- Use Case: Detect suspicious network communications
-- Author: Security Operations Team
-- Created: 2024-01-01

SELECT
    sourceip,
    destinationip,
    destinationport,
    hostname,
    eventtime,
    bytessent,
    bytesreceived,
    COUNT(*) as connection_count
FROM flows
WHERE
    destinationport IN (8080, 1337, 6667, 443) AND
    (hostname MATCHES '.*\.tk' OR
     hostname MATCHES '.*\.ml' OR
     hostname MATCHES '.*pastebin\.com.*') AND
    eventtime > NOW() - INTERVAL '1' HOUR
GROUP BY sourceip, destinationip, destinationport, hostname
HAVING COUNT(*) > 5
ORDER BY connection_count DESC
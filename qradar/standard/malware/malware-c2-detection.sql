-- Malware Command and Control Communication Detection
-- Use Case 3: Detect malware C2 traffic patterns
-- Last Updated: 2024-01-01
-- MITRE ATT&CK: T1071 - Application Layer Protocol

SELECT
    sourceip,
    destinationip,
    destinationport,
    hostname,
    eventtime,
    bytessent,
    bytesreceived,
    protocol,
    CASE 
        WHEN hostname MATCHES '.*\.tk' THEN 'Suspicious TLD (.tk)'
        WHEN hostname MATCHES '.*\.ml' THEN 'Suspicious TLD (.ml)'
        WHEN hostname MATCHES '.*pastebin\.com.*' THEN 'Pastebin Communication'
        WHEN hostname MATCHES '.*\.bit' THEN 'Blockchain DNS'
        WHEN destinationport IN (8080, 1337, 6667) THEN 'Suspicious Port'
        ELSE 'Other Suspicious Pattern'
    END as c2_indicator
FROM flows
WHERE
    (
        destinationport IN (8080, 1337, 6667, 443, 80) AND
        (hostname MATCHES '.*\.tk' OR
         hostname MATCHES '.*\.ml' OR
         hostname MATCHES '.*pastebin\.com.*' OR
         hostname MATCHES '.*\.bit' OR
         hostname MATCHES '.*duckdns\.org.*')
    ) AND
    eventtime > NOW() - INTERVAL '1' HOUR
ORDER BY eventtime DESC
LIMIT 1000;